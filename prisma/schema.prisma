generator client {
  provider = "prisma-client-js"
  // output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum DataSourceType {
  file
  database
  api
  cloud
}

enum DataSourceStatus {
  connected
  syncing
  error
}

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  phoneNumber   String?   @unique
  passwordHash  String
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  workspaces    Workspace[]
  templates     Template[]
  comments      Comment[]
  pages         Page[]
  widgets       Widget[]
  aiConfig      Json      @default("{}")
}

model Workspace {
  id            String        @id @default(uuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  pages         Page[]
  dataSources   DataSource[]
  relationships Relationship[]
  parameters    Parameter[]
  stories       Story[]
}

model Page {
  id            String    @id @default(uuid())
  workspaceId   String
  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  ownerId       String
  owner         User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  name          String
  layouts       Json      @default("{}")
  configuration Json      @default("{}")
  widgetsData   Json      @default("{}")
  globalFilters Json      @default("[]")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  widgets       Widget[]
  bookmarks     Bookmark[]
}

model Widget {
  id            String    @id @default(uuid())
  pageId        String
  page          Page      @relation(fields: [pageId], references: [id], onDelete: Cascade)
  ownerId       String
  owner         User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  title         String
  configuration Json      @default("{}")
  layouts       Json      @default("{}")
  widgetsData   Json      @default("{}")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  comments      Comment[]
}

model DataSource {
  id                String            @id @default(uuid())
  workspaceId       String
  workspace         Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  name              String
  type              DataSourceType
  status            DataSourceStatus  @default(connected)
  connectionDetails Json?
  storageRef        String? // e.g., S3/GCS object path for file-based sources
  fieldsSchema      Json
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  lastSyncedAt      DateTime?
  transformations   Transformation[]
  relationshipsA    Relationship[]    @relation("SourceA")
  relationshipsB    Relationship[]    @relation("SourceB")
}

model Transformation {
  id            String     @id @default(uuid())
  dataSourceId  String
  dataSource    DataSource @relation(fields: [dataSourceId], references: [id], onDelete: Cascade)
  order         Int
  type          String
  payload       Json
  createdAt     DateTime   @default(now())

  @@unique([dataSourceId, order])
}

model Relationship {
  id          String     @id @default(uuid())
  workspaceId String
  workspace   Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  sourceAId   String
  sourceA     DataSource @relation("SourceA", fields: [sourceAId], references: [id])
  fieldA      String
  sourceBId   String
  sourceB     DataSource @relation("SourceB", fields: [sourceBId], references: [id])
  fieldB      String
  type        String
}

model Parameter {
  id          String    @id @default(uuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  name        String
  config      Json
}

model Story {
  id          String    @id @default(uuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  title       String
  pages       Json
}

model Comment {
  id        String   @id @default(uuid())
  widgetId  String
  widget    Widget   @relation(fields: [widgetId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  position  Json
  messages  Json
}

model Bookmark {
  id        String    @id @default(uuid())
  pageId    String
  page      Page      @relation(fields: [pageId], references: [id], onDelete: Cascade)
  name      String
  state     Json
}

model Template {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  definition Json
}
